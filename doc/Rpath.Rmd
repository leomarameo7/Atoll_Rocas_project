---
title: "Rpath for Rocas Atoll Ecosystem"
author: Leonardo Capitani
output:
  pdf_document: default
number_sections: true
linenumbers: true
---

```{r rpath load, echo = F, warning=FALSE}
knitr::opts_chunk$set(
  comment = '#>',
  collapse = T)
library(Rpath)
library(data.table)
library(readr)
```

## Setting up Ecopath

### Parameter file generation

```{r groups}
#Groups and types for the Rocas Atoll Ecosystem

groups <- c('Seabirds', "Negaprion brevirostris",
      "Ginglymostoma cirratum","Lutjanus jocu", 
      "Cephalopholis fulva", "Carangidae","Acanthurus spp.", 
      "Stegastes rocasensis", "Thalassoma noronhanum",
      "Abudefduf saxatilis", "Sparisoma spp.", "Melichthys niger", 
      "Kyphosus spp.", "Mulloidichthys martinicus", 
      "Holocentrus adscensionis","Haemulidae", "Cryptobenthic reef fishes",
      "Turtles","Cephalopoda","Panulirus spp.",
      "Benthic macroinvertebrates", "Benthic microinvertebrates", 
      "Siderastrea stellata","Zooplankton","Phytoplankton","Digenea simplex","Other algal turf", "Detritus", "fleets")

types  <- c(rep(0, 22), 0.8, 0, rep(1, 3), 2, 3)

REco.params <- create.rpath.params(group = groups, 
            type = types, stgroup = NA)
```

```{r How to fill}
#load basic input from my model EwE-  Rocas Atoll
basic_input <- read_csv("data/raw/basic_input.csv")
#Filling columns a Biomass, PB and QB, Biomass accumulation parameters
biomass <- basic_input$`Biomass in habitat area (t/kmÂ²)`
REco.params$model[, Biomass := biomass]

pb <- c(5.4,0.264,0.566,0.524,1.3,1.163,0.96,1.74,1.67,1.22,1.02,1.32,0.73,1.92,1.24,1.07,2.73,0.29,6.4,1.28,3.8,4.94,1.66,87,109.5,274,323,NA, NA)
REco.params$model[, PB := pb]

qb <- c(76.5, 3.2, 3.1, 5.5, 6.7, 11.3, 10.9, 14.7, 14.1, 11.2, 6.2, 10, 27.5, 9.6,8.3, 11.6, 25.1, 2.35, 36.5, 7.4, 10, 16.69, 9.4, 160,NA,NA,NA,NA,NA)
REco.params$model[, QB := qb]

ba <- c(0, 0, 0.558, -0.1378252, 0.1081793, 0.9327999, -0.08161397, -0.005367057, 0.004389316, 0.0818163, 0.2839955, 0.1026, 0, 0.4368, 0.9002874, 0.08392983, -0.1343, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0)
REco.params$model[, BioAcc  := ba]
#Set parameters for Unassimilation
REco.params$model[, Unassim := c(rep(0.2, 20), 0.4,0.4, 0.2,0.4, 0, 0, 0, 0,0)]
#EE for groups w/o biomass
REco.params$model[Group %in% 'Benthic macroinvertebrates', EE := 0.9]
REco.params$model[Group %in% 'Benthic microinvertebrates', EE := 0.85]
#Detrital Fate
REco.params$model[, Detritus := c(rep(1, 27), rep(0, 2))]
#
View(REco.params$model)
```
Note the use of the operator ':=' to assign values.  This is unique to data tables.
Here are the rest of the columns for the model list
```{r Model Table final, echo = F}
knitr::kable(REco.params$model, 
             caption = 'Example of completed model list')

```

###Diet Parameters

The data entered in the diet list is the same as the data entered in the 
diet composition tab in EwE. Just as within EwE, the columns 
represent the predators while the rows represent the prey.  Individual diet components 
can be adjusted by specifying the prey in the 'Group' variable and assigning a value to 
the predator.  For example, if you wanted to assign 10% of the seabird diet as 'Other Groundfish' you could do it like this:
You can also assign the entire diet composition for a predator:

```{r how to fill diet }
#load basic input from my model EwE-  Rocas Atoll
diet_matrix <- read.csv("data/raw/diet_matrix_atoll_rocas.csv")
#remove lines 30 and 31
diet_matrix<- diet_matrix[c(-30,-31),]
#Convert columns X3,X5 and X6 class as numeric
diet_matrix$X3<- as.numeric(paste(diet_matrix$X3))
diet_matrix$X5<- as.numeric(paste(diet_matrix$X5))
diet_matrix$X6<- as.numeric(paste(diet_matrix$X6))
#diet sea birds
seabirds.diet<-diet_matrix$X1
REco.params$diet[, "Seabirds" := seabirds.diet]
#diet Negaprion brevirostris
Negaprion.diet<- diet_matrix$X2
REco.params$diet[,"Negaprion brevirostris":=Negaprion.diet]
#diet Ginglymostoma cirratum
Ginglymostoma.diet<- as.numeric(diet_matrix$X3)
REco.params$diet[,"Ginglymostoma cirratum":=Ginglymostoma.diet]
#diet Lutjanus jocu
Lutjanus_jocu.diet<- as.numeric(diet_matrix$X4)
REco.params$diet[,"Lutjanus jocu":= Lutjanus_jocu.diet]
#diet Cephalopholis fulva
Cephalopholis_fulva.diet<- as.numeric(diet_matrix$X5)
REco.params$diet[,"Cephalopholis fulva":= Cephalopholis_fulva.diet]
#diet Carangidae
Carangidae.diet<- as.numeric(diet_matrix$X6)
REco.params$diet[,"Carangidae":= Carangidae.diet]
#diet Acanthurus spp.
Acanthurus_spp.diet<- as.numeric(diet_matrix$X7)
REco.params$diet[,"Acanthurus spp.":= Acanthurus_spp.diet]
#diet stegastes rocasensis
Stegastes_rocasensis.diet<- as.numeric(diet_matrix$X8)
REco.params$diet[,"Stegastes rocasensis":= Stegastes_rocasensis.diet]
#diet Thalassoma noronhanum
Thalassoma.diet<- as.numeric(diet_matrix$X9)
REco.params$diet[,"Thalassoma noronhanum":= Thalassoma.diet]
#diet Abudefduf saxatilis
Abudefduf.diet <- as.numeric(diet_matrix$X10)
REco.params$diet[,"Abudefduf saxatilis":= Abudefduf.diet]
#diet Sparisoma spp.
Sparisoma_spp.diet <- as.numeric(diet_matrix$X11)
REco.params$diet[,"Sparisoma spp." := Sparisoma_spp.diet]
#diet Melichthys_niger
Melichthys_niger.diet <- as.numeric(diet_matrix$X12)
REco.params$diet[,"Melichthys niger" := Melichthys_niger.diet]
#diet Kyphosus spp.
Kyphosus_spp.diet <- as.numeric(diet_matrix$X13)
REco.params$diet[,"Kyphosus spp." := Kyphosus_spp.diet]
#diet Mulloidichthys_martinicus
Mulloidichthys_martinicus.diet <- as.numeric(diet_matrix$X14)
REco.params$diet[,"Mulloidichthys martinicus" := Mulloidichthys_martinicus.diet]
#diet Holocentrus adscensionis
Holocentrus_adscensionis.diet <- as.numeric(diet_matrix$X15)
REco.params$diet[,"Holocentrus adscensionis" := Holocentrus_adscensionis.diet]
#diet Haemulidae
Haemulidae.diet <- as.numeric(diet_matrix$X16)
REco.params$diet[,"Haemulidae" := Haemulidae.diet]
#diet Cryptobenthic reef fishes
Cryptobenthic.diet <- as.numeric(diet_matrix$X17)
REco.params$diet[,"Cryptobenthic reef fishes" := Cryptobenthic.diet]
#diet Turtles
Turtles.diet <- as.numeric(diet_matrix$X18)
REco.params$diet[,"Turtles" := Turtles.diet]
#diet Cephalopoda
Cephalopoda.diet <- as.numeric(diet_matrix$X19)
REco.params$diet[,"Cephalopoda" := Cephalopoda.diet]
#diet Panulirus spp.
Panulirus_spp.diet <- as.numeric(diet_matrix$X20)
REco.params$diet[,"Panulirus spp.":= Panulirus_spp.diet]

#diet Benthic macroinvertebrates
Benthic_macroinvertebrates.diet <- as.numeric(diet_matrix$X21)
REco.params$diet[,"Benthic macroinvertebrates":= Benthic_macroinvertebrates.diet]

#diet Benthic microinvertebrates
Benthic_microinvertebrates.diet <- as.numeric(diet_matrix$X22)
REco.params$diet[,"Benthic microinvertebrates":= Benthic_microinvertebrates.diet]

#diet Siderastrea stellata
Siderastrea_stellata.diet <- c(0, 0, 0, 0, 0, 0, 0, 0,
                               0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 
                               0, 1, 0, 0, 0, 0, 0) 

REco.params$diet[,"Siderastrea stellata" := Siderastrea_stellata.diet]

#diet Zooplankton
Zooplankton.diet <- as.numeric(diet_matrix$X24)
REco.params$diet[,"Zooplankton" := Zooplankton.diet]
View(REco.params$diet)
```

```{r Dietfile Table, echo=, message=FALSE, warning=FALSE, paged.print=FALSE}
knitr::kable(REco.params$diet, caption = 'Diet parameters for Rocas Atoll Ecosystem', 
             digits = 3, drop0trailing = TRUE)
```

## Running Ecopath

After creating the parameter object, running ecopath in R is relatively 
straightforward.  It is just the function `rpath` supplied with the parameter object.
Additionally, you can supply an ecosystem name for the output.

```{r Running ecopath}
REco <- rpath(REco.params, eco.name = 'Rpath Rocas Atoll marine food web ')
REco
```

The output object from `rpath` is an S3 object type called 'Rpath'.  Rpath objects
are a list of parameters from the mass balance.  However, the `print` function will
display the same information as the "Basic Estimates" tab from EwE. You will also 
notice that the `print` function will display whether the model is balanced or not.
If the model was not balanced, it would list the groups that are not balanced.
Rpath has the same constraint that all DC's should equal one. Rpath only gives errors if you run the `check.rpath.params()` function.
You can also display the mortalities associated with each group by supplying the
argument `morts = T` to the `print` function.

```{r Ecopath morts}
print(REco, morts = T)
check.rpath.params(REco.params)

```

Note that if you wish to save the `print` output you need to use the function
`write.rpath`.  This function will also accept the argument 'morts = T'.

The generic function `summary` will display some summary statistics on the model
as well as a list of attributes you can access.  To access any of the other 
attributes simply use the standard list notation.

```{r Ecopath summaries}
summary(REco)
REco$TL
```


```{r Food Web Plots}

p <- webplot(REco, line.col = "gray44", eco.name = "Rocas Atoll marine food web", labels = T, label.pos = 1, fleets = F, type.col = c("black","forestgreen","brown","white"), label.cex = 0.75, )
p

```










